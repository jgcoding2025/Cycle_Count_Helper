Notes/Definitions:

1. GROUPING
    a. A “group” is one unique item (across all warehouses/locations).
    b. ST01 is treated as its own location row in the group, but it is excluded from secondary variance math.
2. LOCATION CLASSES
    a. Default: the item’s designated default location row.
    b. Secondary: every location row that is not default and not ST01.
    c. ST01: special holding location; excluded from secondary variance calculation.
3. ST01 STATES
    a. Unsecured: inventory offlined in the system that may still physically be in default (timing/process).
    b. Secured: inventory that has been physically pulled and is in ST01.
4. ST01 REFERENCES
    a. ST01 is never physically counted; assume it is correct.
    b. ST01 may only be referenced when ST01 system qty <> 0
    c. If ST01 = 0, the system must not suggest checking ST01 or use ST01 in any reasoning.
5. EXPECTED PHYSICAL RANGE (for tolerance only)
    (Used only to compute default_outside_tolerance_qty when ST01 logic is eligible.)
    a. expected_physical_min = default_system
    b. expected_physical_max = default_system + ST01
6. Definitions
    a. “exists an Available / Available upon request secondary with excess stock”:
        Within the item group, at least one Secondary row (non-default, non-ST01) has Allocation Category = Available or Available upon request and (count − system) > 0


Business Rules: ORDER of OPERATIONS FOR ADJUSTMENTS

Step A — Secondary adjustments
1. Group by Item (ignore warehouse differences; treat all warehouses uniformly in the grouping).
2. For every Secondary row (non-default, non-ST01):
    set_location_qty_to = count
3. Compute net_secondary_adjustments = Σ(count − system) over all non-default, non-ST01 locations.

Step B — Compute default balancing math (always)
    default_adjusted_noconstraint = default_system − net_secondary_adjustments
    default_adjusted_with_constraint = max(default_adjusted_noconstraint, 0)
    residual_unbalanced = default_adjusted_noconstraint - default_adjusted_with_constraint
    
    Interpretation:
    If residual_unbalanced is negative, secondaries are “over-counted” relative to system such that default would need to go below zero to balance;
    we clamp default to 0 and carry the negative residual.

Step C — Compute these two critical tags
1.  eligible_for_ST01_logic = "Yes" if:
        Type is Unsecured
        AND location is Default
        AND Allocation Category is Available or Available upon request
        AND ST01 <> 0
    else "No"
2. unbalanced_secondary = "Yes" if residual_unbalanced is negative, else "No"

Step D — Compute ST01 tolerance quantities (only meaningful when eligible)
    default_outside_tolerance_qty =
        if default_counted < expected_physical_min → default_counted - expected_physical_min
        else if default_counted > expected_physical_max → default_counted - expected_physical_max
        else 0

Step E — Scenarios (2×2 matrix from the two tags)
1. scenario_1 = TRUE if eligible_for_ST01_logic="No" AND unbalanced_secondary="No"
2. scenario_2 = TRUE if eligible_for_ST01_logic="Yes" AND unbalanced_secondary="No"
3. scenario_3 = TRUE if eligible_for_ST01_logic="No" AND unbalanced_secondary="Yes"
4. scenario_4 = TRUE if eligible_for_ST01_logic="Yes" AND unbalanced_secondary="Yes"
    
_scenario returns the matching label (“Scenario 1”…”Scenario 4”).

Step F — Final set_location_qty_to outputs
1. For secondary rows: set_location_qty_to = count
2. ST01 row: No adjustment output (blank / excluded)
3. For default row:
    a. If _scenario = "Scenario 1" → set_location_qty_to = default_counted
    b. If _scenario = "Scenario 2" → set_location_qty_to = default_system + default_outside_tolerance_qty
    c. If _scenario = "Scenario 3" → set_location_qty_to = default_adjusted_with_constraint
    e. If _scenario = "Scenario 4" → set_location_qty_to = default_adjusted_with_constraint
        AND trigger group header for Investigate
        Recommend paths forward:
            If there exists an “Available / Available upon request” secondary with excess stock, recommend:
            Physically transfer {abs(residual_unbalanced)} to the default, then update location count.
        Else recommend:
            Check ST01 - may be inflated by approx. {abs(residual_unbalanced)}

Step G — Trigger "Investigate" header + recommended paths forward when either condition is true:
1. Scenario 4 rule: If _scenario = "Scenario 4" → Investigate = TRUE
2. Residual/ST01 rule (additional, independent)
    a. If residual_unbalanced ≠ 0 AND ST01 > 0 → Investigate = TRUE
    Recommend:
        If there exists an Available / Available upon request Secondary with excess stock (where count > system):
            “Physically transfer {abs(residual_unbalanced)} to the Default, then update location count.”
        Else:
            “Check ST01 — may be inflated by approx. {abs(residual_unbalanced)}.”

STEP H — Output requirement
1. Generate an output indicating what each location quantity should be set to for adjustments to (all locations except ST01).